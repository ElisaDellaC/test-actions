on:
  issue_comment:
    types: [created]
name: rebase
jobs:
  rebase:
    name: Rebase
    if: github.event.issue.pull_request != '' && contains(github.event.comment.body, '/rebase')
    runs-on: ubuntu-latest
    env:
      URL: ${{ github.event.issue.url }}
      URL_COMMENT: ${{ github.event.issue.comments_url }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      ASSIGNEE: ${{ github.event.issue.user.login}}
      RUN_ID: ${{ github.run_id}}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
      - name: Add reaction - rebase started
        uses: khan/pull-request-comment-trigger@master
        id: check
        with: 
          trigger: '/rebase'
          reaction: gfdjglkfdjlgjkd
      - name: Checkout the latest code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Automatic Rebase
        uses: cirrus-actions/rebase@1.3
      - name: Comment PR on success
        if: ${{ success() }}     
        run: |
          curl \
            -X POST \
            $URL_COMMENT \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            --data '{"body": "'"✅ -- Automated Rebase successful - Check https://github.com/$GITHUB_REPOSITORY/actions/runs/$RUN_ID . Remove the test-out-of-date label to trigger a new test run"'"}'     
      - name: Add label
        if: ${{ success() }}     
        run: |
          curl \
            -X POST \
            $URL \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            --data '{"labels":["test-results-out-of-date"]}'
      - name: Comment PR on failure
        if: ${{ failure() }}     
        run: |
          curl \
            -X POST \
            $URL_COMMENT \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            --data '{"body": "'"❌ -- Failure in the Automated Rebase - Check https://github.com/$GITHUB_REPOSITORY/actions/runs/$RUN_ID . @$ASSIGNEE, PR has been flagged as WIP"'"}'     
      - name: Add label
        if: ${{ failure() }}     
        run: |
          curl \
            -X POST \
            $URL \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            --data '{"labels":["WIP"]}'
     
